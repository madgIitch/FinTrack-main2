var e=globalThis,t={},a={},o=e.parcelRequire94c2;null==o&&((o=function(e){if(e in t)return t[e].exports;if(e in a){var o=a[e];delete a[e];var r={id:e,exports:{}};return t[e]=r,o.call(r.exports,r,r.exports),r.exports}var n=Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}).register=function(e,t){a[e]=t},e.parcelRequire94c2=o),o.register;var r=o("gEjZb"),n=o("ilpIi"),c=o("6AR8M");console.log("[HOME] loaded");const i=(0,n.getFirestore)(r.app),s="localhost"===window.location.hostname?"http://localhost:5001/fintrack-1bced/us-central1/api":"https://us-central1-fintrack-1bced.cloudfunctions.net/api";let l=null;window.addEventListener("load",async()=>{await m(),function(){let e=document.getElementById("btn-notifications");if(!e)return;let t=Notification.permission;e.classList.remove("notifs-granted","notifs-denied","notifs-default"),e.classList.add(`notifs-${t}`)}()}),document.addEventListener("DOMContentLoaded",()=>{console.log("[HOME] DOM ready"),document.getElementById("open-sidebar")?.addEventListener("click",()=>document.getElementById("sidebar")?.classList.add("open")),document.getElementById("close-sidebar")?.addEventListener("click",()=>document.getElementById("sidebar")?.classList.remove("open")),document.getElementById("logout-link")?.addEventListener("click",async e=>{e.preventDefault(),await (0,c.signOut)(r.auth),location.href="../index.html"})});var d={};d=import.meta.resolve("kdxr5");var u={};async function m(){if(!("serviceWorker"in navigator)){console.log("[HOME] Service Worker no soportado");return}try{let e=await navigator.serviceWorker.register(d);console.log("[HOME] SW de caché registrado:",e.scope)}catch(e){console.warn("[HOME] Error al registrar SW de caché:",e)}try{let e=await navigator.serviceWorker.register(u,{scope:"/"});if(await navigator.serviceWorker.ready,console.log("[HOME] SW registered and ready, scope:",e.scope),"sync"in e)try{await e.sync.register("sync-transactions"),console.log("[HOME] One-off sync registered")}catch(e){"NotAllowedError"===e.name?console.warn("[HOME] SyncManager deshabilitado por permisos del navegador"):console.warn("[HOME] One-off sync failed:",e)}if("periodicSync"in e)try{let t=await navigator.permissions.query({name:"periodic-background-sync"});"granted"===t.state?(await e.periodicSync.register("sync-transactions",{minInterval:9e5}),console.log("[HOME] periodicSync registered")):console.log("[HOME] periodic-background-sync permiso:",t.state)}catch(e){console.warn("[HOME] periodicSync failed:",e)}navigator.serviceWorker.controller?(navigator.serviceWorker.controller.postMessage({type:"TRIGGER_SYNC"}),console.log("[HOME] Sincronización forzada enviada al SW")):console.warn("[HOME] No hay controlador activo para el SW, no se pudo lanzar TRIGGER_SYNC")}catch(e){console.error("[HOME] SW registration failed:",e)}}async function g(e){let t=`lastSync_${e}`,a=Number(localStorage.getItem(t)),o=Date.now();if(a&&o-a<864e5){console.log("[HOME] Manual sync skipped (recent)");return}try{let a=await fetch(`${s}/plaid/sync_transactions_and_store`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});a.ok?(localStorage.setItem(t,o.toString()),console.log("[HOME] Manual sync OK")):console.warn("[HOME] Manual sync failed, status:",a.status)}catch(e){console.error("[HOME] Manual sync error:",e)}}async function y(e){let t=await (0,n.getDoc)((0,n.doc)(i,"users",e)),a=t.exists()&&t.data().plaid?.accounts||[],o=document.querySelector(".balance-slider");for(let{accessToken:e}of(o.innerHTML="",a))try{let t=await fetch(`${s}/plaid/get_account_details`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e})});if(!t.ok)continue;let{accounts:a=[]}=await t.json(),r=a[0]||{},n=document.createElement("div");n.className="balance-slide",n.innerHTML=`
        <div class="card">
          <p class="card-title">${r.name||"Cuenta"}</p>
          <p class="card-subtitle">Saldo actual</p>
          <p class="card-balance">${(r.balances?.current||0).toFixed(2)} \u{20AC}</p>
        </div>`,o.appendChild(n)}catch(e){console.error("[HOME] Balance fetch error:",e)}!function(){let e=document.querySelector(".balance-slider");if(!e)return;let t=Array.from(e.children),a=0,o=document.getElementById("balance-dots");function r(){e.style.transform=`translateX(-${100*a}%)`,o.childNodes.forEach((e,t)=>e.classList.toggle("active",t===a))}o.innerHTML="",t.forEach((e,t)=>{let n=document.createElement("div");n.className=`slider-dot${0===t?" active":""}`,n.onclick=()=>{a=t,r()},o.appendChild(n)}),document.getElementById("balance-prev").onclick=()=>{a=(a+t.length-1)%t.length,r()},document.getElementById("balance-next").onclick=()=>{a=(a+1)%t.length,r()},r()}()}async function p(e){if(!("indexedDB"in window))return;let t=indexedDB.open("fintrack-db",1);t.onupgradeneeded=()=>t.result.createObjectStore("metadata"),t.onsuccess=()=>{let a=t.result,o=a.transaction("metadata","readwrite");o.objectStore("metadata").put(e,"userId"),o.oncomplete=()=>a.close()}}async function f(e){try{let t=await fetch(`${s}/plaid/get_daily_summary`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});if(!t.ok)throw Error("Error cargando resumen diario");let{dias:a,gastos:o,ingresos:r}=await t.json(),n=document.querySelector("#monthlyChart");if(!n)return;if(n.innerHTML="",l)try{l.destroy()}catch{}(l=new ApexCharts(n,{chart:{type:"bar",toolbar:{show:!1},height:300},series:[{name:"Gastos",data:o},{name:"Ingresos",data:r}],plotOptions:{bar:{borderRadius:4,columnWidth:"40%"}},dataLabels:{enabled:!0,offsetY:-6,style:{fontSize:"12px",fontWeight:"bold",colors:["#000"]},background:{enabled:!1},formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},xaxis:{categories:a,labels:{rotate:-45}},yaxis:{labels:{formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}},tooltip:{y:{formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}},legend:{position:"bottom"},grid:{borderColor:"#eee"}})).render()}catch(e){console.error("[HOME] Daily chart error:",e)}}u=import.meta.resolve("36HDJ"),(0,c.onAuthStateChanged)(r.auth,async e=>{if(console.log("[HOME] Auth state changed:",e),!e){location.href="../index.html";return}try{let t=await (0,n.getDoc)((0,n.doc)(i,"users",e.uid)),a=t.exists()?t.data():{},o=[a.firstName,a.lastName].filter(Boolean).join(" ")||"Usuario";document.getElementById("user-name").textContent=o}catch(e){console.error("[HOME] load profile failed:",e)}await g(e.uid),await y(e.uid),await p(e.uid),await f(e.uid)});
//# sourceMappingURL=home.c1b12fd2.js.map
