var e=globalThis,t={},a={},n=e.parcelRequire94c2;null==n&&((n=function(e){if(e in t)return t[e].exports;if(e in a){var n=a[e];delete a[e];var o={id:e,exports:{}};return t[e]=o,n.call(o.exports,o,o.exports),o.exports}var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){a[e]=t},e.parcelRequire94c2=n),n.register;var o=n("gEjZb"),r=n("ilpIi"),i=n("6AR8M");console.log("[HOME] loaded");const c=(0,r.getFirestore)(o.app),s="localhost"===window.location.hostname?"http://localhost:5001/fintrack-1bced/us-central1/api":"https://us-central1-fintrack-1bced.cloudfunctions.net/api";let l=null;window.addEventListener("load",async()=>{await u(),function(){let e=document.getElementById("btn-notifications");if(!e)return;let t=Notification.permission;e.classList.remove("notifs-granted","notifs-denied","notifs-default"),e.classList.add(`notifs-${t}`)}()}),document.addEventListener("DOMContentLoaded",()=>{console.log("[HOME] DOM ready"),document.getElementById("open-sidebar")?.addEventListener("click",()=>document.getElementById("sidebar")?.classList.add("open")),document.getElementById("close-sidebar")?.addEventListener("click",()=>document.getElementById("sidebar")?.classList.remove("open")),document.getElementById("logout-link")?.addEventListener("click",async e=>{e.preventDefault(),await (0,i.signOut)(o.auth),location.href="../index.html"})});var d={};async function u(){if(!("serviceWorker"in navigator)){console.log("[HOME] Service Worker no soportado");return}try{let e=await navigator.serviceWorker.register(d,{scope:"/"});if(await navigator.serviceWorker.ready,console.log("[HOME] SW registered and ready, scope:",e.scope),"sync"in e)try{await e.sync.register("sync-transactions"),console.log("[HOME] One-off sync registered")}catch(e){"NotAllowedError"===e.name?console.warn("[HOME] SyncManager deshabilitado por permisos del navegador"):console.warn("[HOME] One-off sync failed:",e)}if("periodicSync"in e)try{let t=await navigator.permissions.query({name:"periodic-background-sync"});"granted"===t.state?(await e.periodicSync.register("sync-transactions",{minInterval:9e5}),console.log("[HOME] periodicSync registered")):console.log("[HOME] periodic-background-sync permiso:",t.state)}catch(e){console.warn("[HOME] periodicSync failed:",e)}navigator.serviceWorker.controller?(navigator.serviceWorker.controller.postMessage({type:"TRIGGER_SYNC"}),console.log("[HOME] Sincronizaci√≥n forzada enviada al SW")):console.warn("[HOME] No hay controlador activo para el SW, no se pudo lanzar TRIGGER_SYNC")}catch(e){console.error("[HOME] SW registration failed:",e)}}async function m(e){let t=`lastSync_${e}`,a=Number(localStorage.getItem(t)),n=Date.now();if(a&&n-a<864e5){console.log("[HOME] Manual sync skipped (recent)");return}try{let a=await fetch(`${s}/plaid/sync_transactions_and_store`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});a.ok?(localStorage.setItem(t,n.toString()),console.log("[HOME] Manual sync OK")):console.warn("[HOME] Manual sync failed, status:",a.status)}catch(e){console.error("[HOME] Manual sync error:",e)}}async function y(e){let t=await (0,r.getDoc)((0,r.doc)(c,"users",e)),a=t.exists()&&t.data().plaid?.accounts||[],n=document.querySelector(".balance-slider");for(let{accessToken:e}of(n.innerHTML="",a))try{let t=await fetch(`${s}/plaid/get_account_details`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e})});if(!t.ok)continue;let{accounts:a=[]}=await t.json(),o=a[0]||{},r=document.createElement("div");r.className="balance-slide",r.innerHTML=`
        <div class="card">
          <p class="card-title">${o.name||"Cuenta"}</p>
          <p class="card-subtitle">Saldo actual</p>
          <p class="card-balance">${(o.balances?.current||0).toFixed(2)} \u{20AC}</p>
        </div>`,n.appendChild(r)}catch(e){console.error("[HOME] Balance fetch error:",e)}!function(){let e=document.querySelector(".balance-slider");if(!e)return;let t=Array.from(e.children),a=0,n=document.getElementById("balance-dots");function o(){e.style.transform=`translateX(-${100*a}%)`,n.childNodes.forEach((e,t)=>e.classList.toggle("active",t===a))}n.innerHTML="",t.forEach((e,t)=>{let r=document.createElement("div");r.className=`slider-dot${0===t?" active":""}`,r.onclick=()=>{a=t,o()},n.appendChild(r)}),document.getElementById("balance-prev").onclick=()=>{a=(a+t.length-1)%t.length,o()},document.getElementById("balance-next").onclick=()=>{a=(a+1)%t.length,o()},o()}()}async function g(e){if(!("indexedDB"in window))return;let t=indexedDB.open("fintrack-db",1);t.onupgradeneeded=()=>t.result.createObjectStore("metadata"),t.onsuccess=()=>{let a=t.result,n=a.transaction("metadata","readwrite");n.objectStore("metadata").put(e,"userId"),n.oncomplete=()=>a.close()}}async function p(e){try{let t=await fetch(`${s}/plaid/get_daily_summary`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});if(!t.ok)throw Error("Error cargando resumen diario");let{dias:a,gastos:n,ingresos:o}=await t.json(),r=document.querySelector("#monthlyChart");if(!r)return;if(r.innerHTML="",l)try{l.destroy()}catch{}(l=new ApexCharts(r,{chart:{type:"bar",toolbar:{show:!1},height:300},series:[{name:"Gastos",data:n},{name:"Ingresos",data:o}],plotOptions:{bar:{borderRadius:4,columnWidth:"40%"}},dataLabels:{enabled:!0,offsetY:-6,style:{fontSize:"12px",fontWeight:"bold",colors:["#000"]},background:{enabled:!1},formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)},xaxis:{categories:a,labels:{rotate:-45}},yaxis:{labels:{formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}},tooltip:{y:{formatter:e=>new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(e)}},legend:{position:"bottom"},grid:{borderColor:"#eee"}})).render()}catch(e){console.error("[HOME] Daily chart error:",e)}}d=import.meta.resolve("36HDJ"),(0,i.onAuthStateChanged)(o.auth,async e=>{if(console.log("[HOME] Auth state changed:",e),!e){location.href="../index.html";return}try{let t=await (0,r.getDoc)((0,r.doc)(c,"users",e.uid)),a=t.exists()?t.data():{},n=[a.firstName,a.lastName].filter(Boolean).join(" ")||"Usuario";document.getElementById("user-name").textContent=n}catch(e){console.error("[HOME] load profile failed:",e)}await m(e.uid),await y(e.uid),await g(e.uid),await p(e.uid)});
//# sourceMappingURL=home.ca3911d1.js.map
