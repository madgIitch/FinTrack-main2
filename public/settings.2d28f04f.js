import"./FinTrack-main.401b9eb7.js";var e=globalThis,t={},n={},o=e.parcelRequire94c2;null==o&&((o=function(e){if(e in t)return t[e].exports;if(e in n){var o=n[e];delete n[e];var s={id:e,exports:{}};return t[e]=s,o.call(s.exports,s,s.exports),s.exports}var r=Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){n[e]=t},e.parcelRequire94c2=o),o.register;var s=o("gEjZb"),r=o("ilpIi"),i=o("6AR8M"),a=o("1s7jw");let c=(0,r.getFirestore)(s.app),l=(0,a.getMessaging)(s.app),d="BHf0cuTWZG91RETsBmmlc1xw3fzn-OWyonshT819ISjKsnOnttYbX8gm6dln7mAiGf5SyxjP52IcUMTAp0J4Vao";async function u(){console.group("[settings.js] ► subscribeUserToPush START");try{let e=s.auth.currentUser;if(!e)throw Error("No user logged in");let t=e.uid,n=await (0,a.getToken)(l,{vapidKey:d});console.log("[settings.js] FCM token obtenido:",n),n?(await c.collection("users").doc(t).collection("fcmTokens").doc(n).set({createdAt:(0,r.serverTimestamp)(),userAgent:navigator.userAgent}),console.log("[settings.js] Token FCM guardado en Firestore")):console.warn("[settings.js] No se pudo obtener token de registro FCM.")}catch(e){throw console.error("[settings.js] subscribeUserToPush ERROR:",e),e}finally{console.groupEnd()}}async function g(){console.group("[settings.js] ► unsubscribeUserFromPush START");try{let e=s.auth.currentUser;if(!e)throw Error("No user logged in");let t=e.uid,n=await (0,a.getToken)(l,{vapidKey:d});if(n){let e=await (0,a.deleteToken)(l);console.log("[settings.js] Token FCM eliminado en cliente:",e),await c.collection("users").doc(t).collection("fcmTokens").doc(n).delete(),console.log("[settings.js] Token FCM eliminado de Firestore")}else console.warn("[settings.js] No hay token FCM para eliminar.")}catch(e){throw console.error("[settings.js] unsubscribeUserFromPush ERROR:",e),e}finally{console.groupEnd()}}function p(e="",t=""){let n=document.createElement("div");n.className="budget-row";let o=document.createElement("select");o.className="category-select";let s=document.createElement("option");s.value="",s.textContent="— Selecciona categoría —",s.disabled=!0,s.selected=!e,o.append(s),m.forEach(t=>{let n=document.createElement("option");n.value=t,n.textContent=t,t===e&&(n.selected=!0),o.append(n)});let r=document.createElement("input");r.type="number",r.className="budget-input",r.placeholder="0,00",r.min="0",r.step="0.01",""===t||isNaN(t)||(r.value=parseFloat(t).toFixed(2));let i=document.createElement("button");return i.type="button",i.className="remove-btn",i.textContent="Eliminar",i.addEventListener("click",()=>n.remove()),n.append(o,r,i),n}let m=[];document.addEventListener("DOMContentLoaded",()=>{console.log("[settings.js] DOMContentLoaded");let e=document.getElementById("back-btn"),t=document.getElementById("notif-push"),n=document.getElementById("notif-email"),o=document.getElementById("report-push"),a=document.getElementById("report-email"),l=document.getElementById("save-settings-btn"),d=document.getElementById("budgets-container"),h=document.getElementById("add-category-btn");e.addEventListener("click",()=>window.history.back()),h.addEventListener("click",()=>{d.appendChild(p())}),t.addEventListener("change",async()=>{if(console.log("[settings.js] notif-push changed:",t.checked),t.checked){if("default"===Notification.permission){let e=await Notification.requestPermission();if(console.log("[settings.js] Notification.permission after request:",e),"granted"!==e){alert("Debes permitir notificaciones para activar Push."),t.checked=!1;return}}try{await u()}catch(e){console.error("[settings.js] subscribeUserToPush error:",e),t.checked=!1}}else try{await g()}catch(e){console.error("[settings.js] unsubscribeUserFromPush error:",e),t.checked=!0}}),(0,i.onAuthStateChanged)(s.auth,async e=>{if(console.log("[settings.js] onAuthStateChanged:",e),!e)return window.location.href="../index.html";let s=e.uid,i=(0,r.doc)(c,"users",s);try{m=(await (0,r.getDocs)((0,r.collection)(c,"groups"))).docs.map(e=>e.id),console.log("[settings.js] allCategories:",m)}catch(e){console.error("[settings.js] Error loading groups:",e),m=[]}let l={};try{let e=await (0,r.getDoc)(i);l=e.exists()&&e.data().settings||{},console.log("[settings.js] loaded settings:",l)}catch(e){console.error("[settings.js] Error loading settings:",e)}t.checked=!!l.notifications?.push,n.checked=!!l.notifications?.email,o.checked=!!l.reports?.push,a.checked=!!l.reports?.email,d.innerHTML="";let u=l.budgets||{};Object.entries(u).forEach(([e,t])=>{m.includes(e)||m.push(e),d.appendChild(p(e,t))}),Object.keys(u).length||d.appendChild(p())}),l.addEventListener("click",async()=>{console.log("[settings.js] Guardar Ajustes click"),l.disabled=!0;let e=l.textContent;l.textContent="Guardando…";let i={notifications:{push:t.checked,email:n.checked},reports:{push:o.checked,email:a.checked},budgets:{}},u=Array.from(d.children),g=new Set,p=!0,m="";if(u.forEach((e,t)=>{let n=e.querySelector(".category-select").value,o=e.querySelector(".budget-input").value.trim();if(!n)return;let s=parseFloat(o);if(isNaN(s)||s<0){p=!1,m=`Fila ${t+1}: monto inv\xe1lido para "${n}".`;return}if(g.has(n)){p=!1,m=`Categor\xeda "${n}" repetida.`;return}g.add(n),i.budgets[n]=s}),!p){alert(m),l.textContent="Error, reintenta",setTimeout(()=>{l.disabled=!1,l.textContent=e},2e3);return}try{let e=s.auth.currentUser;if(!e)throw Error("No user logged in");let t=(0,r.doc)(c,"users",e.uid);await (0,r.updateDoc)(t,{settings:i}),console.log("[settings.js] Settings updated in Firestore"),console.log("[settings.js] Calling sync endpoint"),await fetch(`${apiUrl}/plaid/sync_transactions_and_store`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e.uid})}),console.log("[settings.js] Sync endpoint called"),l.textContent="¡Guardado y sincronizado!"}catch(e){console.error("[settings.js] Error saving or syncing:",e),l.textContent="Error, reintenta"}finally{setTimeout(()=>{l.disabled=!1,l.textContent=e},1500)}})});
//# sourceMappingURL=settings.2d28f04f.js.map
