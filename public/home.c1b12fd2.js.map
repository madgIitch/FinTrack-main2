{"mappings":"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","sources":["<anon>","js/home.js","node_modules/@parcel/runtime-js/lib/runtime-666092b986dc094c.js","node_modules/@parcel/runtime-js/lib/runtime-91771f530c9bdde6.js"],"sourcesContent":["\n      var $parcel$global = globalThis;\n    \nvar $parcel$modules = {};\nvar $parcel$inits = {};\n\nvar parcelRequire = $parcel$global[\"parcelRequire94c2\"];\n\nif (parcelRequire == null) {\n  parcelRequire = function(id) {\n    if (id in $parcel$modules) {\n      return $parcel$modules[id].exports;\n    }\n    if (id in $parcel$inits) {\n      var init = $parcel$inits[id];\n      delete $parcel$inits[id];\n      var module = {id: id, exports: {}};\n      $parcel$modules[id] = module;\n      init.call(module.exports, module, module.exports);\n      return module.exports;\n    }\n    var err = new Error(\"Cannot find module '\" + id + \"'\");\n    err.code = 'MODULE_NOT_FOUND';\n    throw err;\n  };\n\n  parcelRequire.register = function register(id, init) {\n    $parcel$inits[id] = init;\n  };\n\n  $parcel$global[\"parcelRequire94c2\"] = parcelRequire;\n}\n\nvar parcelRegister = parcelRequire.register;\n\nvar $gEjZb = parcelRequire(\"gEjZb\");\n\nvar $ilpIi = parcelRequire(\"ilpIi\");\n\nvar $6AR8M = parcelRequire(\"6AR8M\");\nconsole.log('[HOME] loaded');\nconst $c73bcadfc547eb5a$var$db = (0, $ilpIi.getFirestore)((0, $gEjZb.app));\nconst $c73bcadfc547eb5a$var$apiUrl = window.location.hostname === 'localhost' ? 'http://localhost:5001/fintrack-1bced/us-central1/api' : 'https://us-central1-fintrack-1bced.cloudfunctions.net/api';\nlet $c73bcadfc547eb5a$var$monthlyChart = null;\nwindow.addEventListener('load', async ()=>{\n    await $c73bcadfc547eb5a$var$setupBackgroundSync();\n    $c73bcadfc547eb5a$var$updateNotificationIconStyle();\n});\ndocument.addEventListener('DOMContentLoaded', ()=>{\n    console.log('[HOME] DOM ready');\n    document.getElementById('open-sidebar')?.addEventListener('click', ()=>document.getElementById('sidebar')?.classList.add('open'));\n    document.getElementById('close-sidebar')?.addEventListener('click', ()=>document.getElementById('sidebar')?.classList.remove('open'));\n    document.getElementById('logout-link')?.addEventListener('click', async (e)=>{\n        e.preventDefault();\n        await (0, $6AR8M.signOut)((0, $gEjZb.auth));\n        location.href = '../index.html';\n    });\n});\nfunction $c73bcadfc547eb5a$var$updateNotificationIconStyle() {\n    const btn = document.getElementById('btn-notifications');\n    if (!btn) return;\n    const state = Notification.permission;\n    btn.classList.remove('notifs-granted', 'notifs-denied', 'notifs-default');\n    btn.classList.add(`notifs-${state}`);\n}\nvar $b1071d67ed79e20a$exports = {};\n$b1071d67ed79e20a$exports = import.meta.resolve(\"kdxr5\");\n\n\nvar $6ef5b16908865674$exports = {};\n$6ef5b16908865674$exports = import.meta.resolve(\"36HDJ\");\n\n\nasync function $c73bcadfc547eb5a$var$setupBackgroundSync() {\n    if (!('serviceWorker' in navigator)) {\n        console.log('[HOME] Service Worker no soportado');\n        return;\n    }\n    // ── Registro adicional del Service Worker de caché ─────────────────────\n    try {\n        const cacheSWReg = await navigator.serviceWorker.register($b1071d67ed79e20a$exports);\n        console.log(\"[HOME] SW de cach\\xe9 registrado:\", cacheSWReg.scope);\n    } catch (err) {\n        console.warn(\"[HOME] Error al registrar SW de cach\\xe9:\", err);\n    }\n    try {\n        const registration = await navigator.serviceWorker.register($6ef5b16908865674$exports, {\n            scope: '/'\n        });\n        await navigator.serviceWorker.ready;\n        console.log('[HOME] SW registered and ready, scope:', registration.scope);\n        // ── Registro del One-off Sync ───────────────────────────────────────\n        if ('sync' in registration) try {\n            await registration.sync.register('sync-transactions');\n            console.log('[HOME] One-off sync registered');\n        } catch (e) {\n            if (e.name === 'NotAllowedError') console.warn('[HOME] SyncManager deshabilitado por permisos del navegador');\n            else console.warn('[HOME] One-off sync failed:', e);\n        }\n        // ── Registro del Periodic Background Sync ───────────────────────────\n        if ('periodicSync' in registration) try {\n            const status = await navigator.permissions.query({\n                name: 'periodic-background-sync'\n            });\n            if (status.state === 'granted') {\n                await registration.periodicSync.register('sync-transactions', {\n                    minInterval: 900000 // 15 minutos\n                });\n                console.log('[HOME] periodicSync registered');\n            } else console.log('[HOME] periodic-background-sync permiso:', status.state);\n        } catch (e) {\n            console.warn('[HOME] periodicSync failed:', e);\n        }\n        // ── Lanzar sincronización forzada manual mediante postMessage ──────\n        if (navigator.serviceWorker.controller) {\n            navigator.serviceWorker.controller.postMessage({\n                type: 'TRIGGER_SYNC'\n            });\n            console.log(\"[HOME] Sincronizaci\\xf3n forzada enviada al SW\");\n        } else console.warn('[HOME] No hay controlador activo para el SW, no se pudo lanzar TRIGGER_SYNC');\n    } catch (err) {\n        console.error('[HOME] SW registration failed:', err);\n    }\n}\n(0, $6AR8M.onAuthStateChanged)((0, $gEjZb.auth), async (user)=>{\n    console.log('[HOME] Auth state changed:', user);\n    if (!user) {\n        location.href = '../index.html';\n        return;\n    }\n    try {\n        const snap = await (0, $ilpIi.getDoc)((0, $ilpIi.doc)($c73bcadfc547eb5a$var$db, 'users', user.uid));\n        const data = snap.exists() ? snap.data() : {};\n        const name = [\n            data.firstName,\n            data.lastName\n        ].filter(Boolean).join(' ') || 'Usuario';\n        document.getElementById('user-name').textContent = name;\n    } catch (e) {\n        console.error('[HOME] load profile failed:', e);\n    }\n    await $c73bcadfc547eb5a$var$manualSync(user.uid);\n    await $c73bcadfc547eb5a$var$loadBalances(user.uid);\n    await $c73bcadfc547eb5a$var$saveUID(user.uid);\n    await $c73bcadfc547eb5a$var$loadDailyChart(user.uid);\n});\nasync function $c73bcadfc547eb5a$var$manualSync(uid) {\n    const key = `lastSync_${uid}`;\n    const last = Number(localStorage.getItem(key));\n    const now = Date.now();\n    if (last && now - last < 86400e3) {\n        console.log('[HOME] Manual sync skipped (recent)');\n        return;\n    }\n    try {\n        const res = await fetch(`${$c73bcadfc547eb5a$var$apiUrl}/plaid/sync_transactions_and_store`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                userId: uid\n            })\n        });\n        if (res.ok) {\n            localStorage.setItem(key, now.toString());\n            console.log('[HOME] Manual sync OK');\n        } else console.warn('[HOME] Manual sync failed, status:', res.status);\n    } catch (e) {\n        console.error('[HOME] Manual sync error:', e);\n    }\n}\nasync function $c73bcadfc547eb5a$var$loadBalances(userId) {\n    const snap = await (0, $ilpIi.getDoc)((0, $ilpIi.doc)($c73bcadfc547eb5a$var$db, 'users', userId));\n    const accounts = snap.exists() ? snap.data().plaid?.accounts || [] : [];\n    const slider = document.querySelector('.balance-slider');\n    slider.innerHTML = '';\n    for (const { accessToken: accessToken } of accounts)try {\n        const res = await fetch(`${$c73bcadfc547eb5a$var$apiUrl}/plaid/get_account_details`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                accessToken: accessToken\n            })\n        });\n        if (!res.ok) continue;\n        const { accounts: accs = [] } = await res.json();\n        const acc = accs[0] || {};\n        const card = document.createElement('div');\n        card.className = 'balance-slide';\n        card.innerHTML = `\n        <div class=\"card\">\n          <p class=\"card-title\">${acc.name || 'Cuenta'}</p>\n          <p class=\"card-subtitle\">Saldo actual</p>\n          <p class=\"card-balance\">${(acc.balances?.current || 0).toFixed(2)} \\u{20AC}</p>\n        </div>`;\n        slider.appendChild(card);\n    } catch (e) {\n        console.error('[HOME] Balance fetch error:', e);\n    }\n    $c73bcadfc547eb5a$var$initSlider();\n}\nfunction $c73bcadfc547eb5a$var$initSlider() {\n    const slider = document.querySelector('.balance-slider');\n    if (!slider) return;\n    const slides = Array.from(slider.children);\n    let idx = 0;\n    const dots = document.getElementById('balance-dots');\n    dots.innerHTML = '';\n    slides.forEach((_, i)=>{\n        const dot = document.createElement('div');\n        dot.className = `slider-dot${i === 0 ? ' active' : ''}`;\n        dot.onclick = ()=>{\n            idx = i;\n            update();\n        };\n        dots.appendChild(dot);\n    });\n    document.getElementById('balance-prev').onclick = ()=>{\n        idx = (idx + slides.length - 1) % slides.length;\n        update();\n    };\n    document.getElementById('balance-next').onclick = ()=>{\n        idx = (idx + 1) % slides.length;\n        update();\n    };\n    function update() {\n        slider.style.transform = `translateX(-${idx * 100}%)`;\n        dots.childNodes.forEach((d, i)=>d.classList.toggle('active', i === idx));\n    }\n    update();\n}\nasync function $c73bcadfc547eb5a$var$saveUID(uid) {\n    if (!('indexedDB' in window)) return;\n    const req = indexedDB.open('fintrack-db', 1);\n    req.onupgradeneeded = ()=>req.result.createObjectStore('metadata');\n    req.onsuccess = ()=>{\n        const db = req.result;\n        const tx = db.transaction('metadata', 'readwrite');\n        tx.objectStore('metadata').put(uid, 'userId');\n        tx.oncomplete = ()=>db.close();\n    };\n}\nasync function $c73bcadfc547eb5a$var$loadDailyChart(userId) {\n    try {\n        const res = await fetch(`${$c73bcadfc547eb5a$var$apiUrl}/plaid/get_daily_summary`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({\n                userId: userId\n            })\n        });\n        if (!res.ok) throw new Error('Error cargando resumen diario');\n        const { dias: dias, gastos: gastos, ingresos: ingresos } = await res.json();\n        const options = {\n            chart: {\n                type: 'bar',\n                toolbar: {\n                    show: false\n                },\n                height: 300\n            },\n            series: [\n                {\n                    name: 'Gastos',\n                    data: gastos\n                },\n                {\n                    name: 'Ingresos',\n                    data: ingresos\n                }\n            ],\n            plotOptions: {\n                bar: {\n                    borderRadius: 4,\n                    columnWidth: '40%'\n                }\n            },\n            dataLabels: {\n                enabled: true,\n                offsetY: -6,\n                style: {\n                    fontSize: '12px',\n                    fontWeight: 'bold',\n                    colors: [\n                        '#000'\n                    ]\n                },\n                background: {\n                    enabled: false\n                },\n                formatter: (v)=>new Intl.NumberFormat('es-ES', {\n                        style: 'currency',\n                        currency: 'EUR',\n                        minimumFractionDigits: 0,\n                        maximumFractionDigits: 0\n                    }).format(v)\n            },\n            xaxis: {\n                categories: dias,\n                labels: {\n                    rotate: -45\n                }\n            },\n            yaxis: {\n                labels: {\n                    formatter: (v)=>new Intl.NumberFormat('es-ES', {\n                            style: 'currency',\n                            currency: 'EUR'\n                        }).format(v)\n                }\n            },\n            tooltip: {\n                y: {\n                    formatter: (v)=>new Intl.NumberFormat('es-ES', {\n                            style: 'currency',\n                            currency: 'EUR'\n                        }).format(v)\n                }\n            },\n            legend: {\n                position: 'bottom'\n            },\n            grid: {\n                borderColor: '#eee'\n            }\n        };\n        const el = document.querySelector('#monthlyChart');\n        if (!el) return;\n        el.innerHTML = '';\n        if ($c73bcadfc547eb5a$var$monthlyChart) try {\n            $c73bcadfc547eb5a$var$monthlyChart.destroy();\n        } catch  {}\n        $c73bcadfc547eb5a$var$monthlyChart = new ApexCharts(el, options);\n        $c73bcadfc547eb5a$var$monthlyChart.render();\n    } catch (e) {\n        console.error('[HOME] Daily chart error:', e);\n    }\n}\n\n\n//# sourceMappingURL=home.c1b12fd2.js.map\n","import { auth, app } from './firebase.js';\nimport {\n  getFirestore,\n  doc,\n  getDoc,\n  collection,\n  getDocsFromServer,\n  getDocs\n} from 'firebase/firestore';\nimport { onAuthStateChanged, signOut } from 'firebase/auth';\n\nconsole.log('[HOME] loaded');\n\nconst db = getFirestore(app);\n\nconst apiUrl = window.location.hostname === 'localhost'\n  ? 'http://localhost:5001/fintrack-1bced/us-central1/api'\n  : 'https://us-central1-fintrack-1bced.cloudfunctions.net/api';\n\nlet monthlyChart = null;\n\nwindow.addEventListener('load', async () => {\n  await setupBackgroundSync();\n  updateNotificationIconStyle();\n});\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  console.log('[HOME] DOM ready');\n\n  document.getElementById('open-sidebar')?.addEventListener('click', () =>\n    document.getElementById('sidebar')?.classList.add('open')\n  );\n  document.getElementById('close-sidebar')?.addEventListener('click', () =>\n    document.getElementById('sidebar')?.classList.remove('open')\n  );\n\n  document.getElementById('logout-link')?.addEventListener('click', async e => {\n    e.preventDefault();\n    await signOut(auth);\n    location.href = '../index.html';\n  });\n});\n\nfunction updateNotificationIconStyle() {\n  const btn = document.getElementById('btn-notifications');\n  if (!btn) return;\n  const state = Notification.permission;\n  btn.classList.remove('notifs-granted', 'notifs-denied', 'notifs-default');\n  btn.classList.add(`notifs-${state}`);\n}\n\nasync function setupBackgroundSync() {\n  if (!('serviceWorker' in navigator)) {\n    console.log('[HOME] Service Worker no soportado');\n    return;\n  }\n\n  // ── Registro adicional del Service Worker de caché ─────────────────────\n  try {\n    const cacheSWReg = await navigator.serviceWorker.register(\n      new URL('/sw-static-cache.js', import.meta.url)\n    );\n    console.log('[HOME] SW de caché registrado:', cacheSWReg.scope);\n  } catch (err) {\n    console.warn('[HOME] Error al registrar SW de caché:', err);\n  }\n\n  try {\n    const registration = await navigator.serviceWorker.register(\n      new URL('../service-worker.js', import.meta.url),\n      { scope: '/' }\n    );\n\n    await navigator.serviceWorker.ready;\n    console.log('[HOME] SW registered and ready, scope:', registration.scope);\n\n    // ── Registro del One-off Sync ───────────────────────────────────────\n    if ('sync' in registration) {\n      try {\n        await registration.sync.register('sync-transactions');\n        console.log('[HOME] One-off sync registered');\n      } catch (e) {\n        if (e.name === 'NotAllowedError') {\n          console.warn('[HOME] SyncManager deshabilitado por permisos del navegador');\n        } else {\n          console.warn('[HOME] One-off sync failed:', e);\n        }\n      }\n    }\n\n    // ── Registro del Periodic Background Sync ───────────────────────────\n    if ('periodicSync' in registration) {\n      try {\n        const status = await navigator.permissions.query({ name: 'periodic-background-sync' });\n        if (status.state === 'granted') {\n          await registration.periodicSync.register('sync-transactions', {\n            minInterval: 15 * 60 * 1000 // 15 minutos\n          });\n          console.log('[HOME] periodicSync registered');\n        } else {\n          console.log('[HOME] periodic-background-sync permiso:', status.state);\n        }\n      } catch (e) {\n        console.warn('[HOME] periodicSync failed:', e);\n      }\n    }\n\n    // ── Lanzar sincronización forzada manual mediante postMessage ──────\n    if (navigator.serviceWorker.controller) {\n      navigator.serviceWorker.controller.postMessage({ type: 'TRIGGER_SYNC' });\n      console.log('[HOME] Sincronización forzada enviada al SW');\n    } else {\n      console.warn('[HOME] No hay controlador activo para el SW, no se pudo lanzar TRIGGER_SYNC');\n    }\n\n  } catch (err) {\n    console.error('[HOME] SW registration failed:', err);\n  }\n}\n\n\n\nonAuthStateChanged(auth, async user => {\n  console.log('[HOME] Auth state changed:', user);\n  if (!user) {\n    location.href = '../index.html';\n    return;\n  }\n\n  try {\n    const snap = await getDoc(doc(db, 'users', user.uid));\n    const data = snap.exists() ? snap.data() : {};\n    const name = [data.firstName, data.lastName].filter(Boolean).join(' ') || 'Usuario';\n    document.getElementById('user-name').textContent = name;\n  } catch (e) {\n    console.error('[HOME] load profile failed:', e);\n  }\n\n  await manualSync(user.uid);\n  await loadBalances(user.uid);\n  await saveUID(user.uid);\n  await loadDailyChart(user.uid);\n});\n\nasync function manualSync(uid) {\n  const key = `lastSync_${uid}`;\n  const last = Number(localStorage.getItem(key));\n  const now = Date.now();\n  if (last && now - last < 86400e3) {\n    console.log('[HOME] Manual sync skipped (recent)');\n    return;\n  }\n  try {\n    const res = await fetch(`${apiUrl}/plaid/sync_transactions_and_store`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ userId: uid })\n    });\n    if (res.ok) {\n      localStorage.setItem(key, now.toString());\n      console.log('[HOME] Manual sync OK');\n    } else {\n      console.warn('[HOME] Manual sync failed, status:', res.status);\n    }\n  } catch (e) {\n    console.error('[HOME] Manual sync error:', e);\n  }\n}\n\nasync function loadBalances(userId) {\n  const snap = await getDoc(doc(db, 'users', userId));\n  const accounts = snap.exists() ? snap.data().plaid?.accounts || [] : [];\n  const slider = document.querySelector('.balance-slider');\n  slider.innerHTML = '';\n  for (const { accessToken } of accounts) {\n    try {\n      const res = await fetch(`${apiUrl}/plaid/get_account_details`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ accessToken })\n      });\n      if (!res.ok) continue;\n      const { accounts: accs = [] } = await res.json();\n      const acc = accs[0] || {};\n      const card = document.createElement('div');\n      card.className = 'balance-slide';\n      card.innerHTML = `\n        <div class=\"card\">\n          <p class=\"card-title\">${acc.name || 'Cuenta'}</p>\n          <p class=\"card-subtitle\">Saldo actual</p>\n          <p class=\"card-balance\">${(acc.balances?.current || 0).toFixed(2)} €</p>\n        </div>`;\n      slider.appendChild(card);\n    } catch (e) {\n      console.error('[HOME] Balance fetch error:', e);\n    }\n  }\n  initSlider();\n}\n\nfunction initSlider() {\n  const slider = document.querySelector('.balance-slider');\n  if (!slider) return;\n  const slides = Array.from(slider.children);\n  let idx = 0;\n  const dots = document.getElementById('balance-dots');\n  dots.innerHTML = '';\n  slides.forEach((_, i) => {\n    const dot = document.createElement('div');\n    dot.className = `slider-dot${i === 0 ? ' active' : ''}`;\n    dot.onclick = () => { idx = i; update(); };\n    dots.appendChild(dot);\n  });\n  document.getElementById('balance-prev').onclick = () => { idx = (idx + slides.length - 1) % slides.length; update(); };\n  document.getElementById('balance-next').onclick = () => { idx = (idx + 1) % slides.length; update(); };\n  function update() {\n    slider.style.transform = `translateX(-${idx * 100}%)`;\n    dots.childNodes.forEach((d,i) => d.classList.toggle('active', i===idx));\n  }\n  update();\n}\n\nasync function saveUID(uid) {\n  if (!('indexedDB' in window)) return;\n  const req = indexedDB.open('fintrack-db', 1);\n  req.onupgradeneeded = () => req.result.createObjectStore('metadata');\n  req.onsuccess = () => {\n    const db = req.result;\n    const tx = db.transaction('metadata', 'readwrite');\n    tx.objectStore('metadata').put(uid, 'userId');\n    tx.oncomplete = () => db.close();\n  };\n}\n\nasync function loadDailyChart(userId) {\n  try {\n    const res = await fetch(`${apiUrl}/plaid/get_daily_summary`, {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ userId })\n    });\n    if (!res.ok) throw new Error('Error cargando resumen diario');\n    const { dias, gastos, ingresos } = await res.json();\n\n    const options = {\n      chart: { type:'bar', toolbar:{ show:false }, height : 300 },\n      series: [\n        { name:'Gastos',   data: gastos },\n        { name:'Ingresos', data: ingresos }\n      ],\n      plotOptions: { bar:{ borderRadius:4, columnWidth:'40%' } },\n      dataLabels: {\n        enabled: true,\n        offsetY: -6,\n        style: {\n          fontSize: '12px',\n          fontWeight: 'bold',\n          colors: ['#000']\n        },\n        background: {\n          enabled: false\n        },\n        formatter: v => new Intl.NumberFormat('es-ES', {\n          style: 'currency',\n          currency: 'EUR',\n          minimumFractionDigits: 0,\n          maximumFractionDigits: 0\n        }).format(v)\n      },\n      xaxis:{ categories: dias, labels: { rotate: -45 } },\n      yaxis:{ labels:{ formatter:v=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v) } },\n      tooltip:{ y:{ formatter:v=>new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR'}).format(v) } },\n      legend:{ position:'bottom' },\n      grid:{ borderColor:'#eee' }\n    };\n\n    const el = document.querySelector('#monthlyChart');\n    if (!el) return;\n    el.innerHTML = '';\n    if (monthlyChart) try{ monthlyChart.destroy(); }catch{}\n    monthlyChart = new ApexCharts(el, options);\n    monthlyChart.render();\n\n  } catch (e) {\n    console.error('[HOME] Daily chart error:', e);\n  }\n}\n","module.exports = __parcel__import__.meta.resolve(\"kdxr5\");","module.exports = __parcel__import__.meta.resolve(\"36HDJ\");"],"names":["$parcel$global","globalThis","$parcel$modules","$parcel$inits","parcelRequire","id","exports","init","module","call","err","Error","code","register","$gEjZb","$ilpIi","$6AR8M","console","log","$c73bcadfc547eb5a$var$db","getFirestore","app","$c73bcadfc547eb5a$var$apiUrl","window","location","hostname","$c73bcadfc547eb5a$var$monthlyChart","addEventListener","$c73bcadfc547eb5a$var$setupBackgroundSync","$c73bcadfc547eb5a$var$updateNotificationIconStyle","btn","document","getElementById","state","Notification","permission","classList","remove","add","e","preventDefault","signOut","auth","href","$b1071d67ed79e20a$exports","resolve","$6ef5b16908865674$exports","navigator","cacheSWReg","serviceWorker","scope","warn","registration","ready","sync","name","status","permissions","query","periodicSync","minInterval","controller","postMessage","type","error","$c73bcadfc547eb5a$var$manualSync","uid","key","last","Number","localStorage","getItem","now","Date","res","fetch","method","headers","body","JSON","stringify","userId","ok","setItem","toString","$c73bcadfc547eb5a$var$loadBalances","snap","getDoc","doc","accounts","exists","data","plaid","slider","querySelector","accessToken","innerHTML","accs","json","acc","card","createElement","className","balances","current","toFixed","appendChild","$c73bcadfc547eb5a$var$initSlider","slides","Array","from","children","idx","dots","update","style","transform","childNodes","forEach","d","i","toggle","_","dot","onclick","length","$c73bcadfc547eb5a$var$saveUID","req","indexedDB","open","onupgradeneeded","result","createObjectStore","onsuccess","db","tx","transaction","objectStore","put","oncomplete","close","$c73bcadfc547eb5a$var$loadDailyChart","dias","gastos","ingresos","el","destroy","ApexCharts","chart","toolbar","show","height","series","plotOptions","bar","borderRadius","columnWidth","dataLabels","enabled","offsetY","fontSize","fontWeight","colors","background","formatter","v","Intl","NumberFormat","currency","minimumFractionDigits","maximumFractionDigits","format","xaxis","categories","labels","rotate","yaxis","tooltip","y","legend","position","grid","borderColor","render","onAuthStateChanged","user","firstName","lastName","filter","Boolean","join","textContent"],"version":3,"file":"home.c1b12fd2.js.map"}