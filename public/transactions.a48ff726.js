let e,t,n,o;import"./FinTrack-main.401b9eb7.js";var r=globalThis,a={},c={},s=r.parcelRequire94c2;null==s&&((s=function(e){if(e in a)return a[e].exports;if(e in c){var t=c[e];delete c[e];var n={id:e,exports:{}};return a[e]=n,t.call(n.exports,n,n.exports),n.exports}var o=Error("Cannot find module '"+e+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(e,t){c[e]=t},r.parcelRequire94c2=s),s.register;var i=s("gEjZb"),l=s("6AR8M"),d=s("ilpIi");let u=(e,t)=>t.some(t=>e instanceof t),h=new WeakMap,g=new WeakMap,p=new WeakMap,m={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return h.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function f(n){if(n instanceof IDBRequest){let e=new Promise((e,t)=>{let o=()=>{n.removeEventListener("success",r),n.removeEventListener("error",a)},r=()=>{e(f(n.result)),o()},a=()=>{t(n.error),o()};n.addEventListener("success",r),n.addEventListener("error",a)});return p.set(e,n),e}if(g.has(n))return g.get(n);let o=function(n){if("function"==typeof n)return(t||(t=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(n)?function(...e){return n.apply(y(this),e),f(this.request)}:function(...e){return f(n.apply(y(this),e))};return(n instanceof IDBTransaction&&!function(e){if(h.has(e))return;let t=new Promise((t,n)=>{let o=()=>{e.removeEventListener("complete",r),e.removeEventListener("error",a),e.removeEventListener("abort",a)},r=()=>{t(),o()},a=()=>{n(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",r),e.addEventListener("error",a),e.addEventListener("abort",a)});h.set(e,t)}(n),u(n,e||(e=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(n,m):n}(n);return o!==n&&(g.set(n,o),p.set(o,n)),o}let y=e=>p.get(e),I=["get","getKey","getAll","getAllKeys","count"],w=["put","add","delete","clear"],v=new Map;function E(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(v.get(t))return v.get(t);let n=t.replace(/FromIndex$/,""),o=t!==n,r=w.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!(r||I.includes(n)))return;let a=async function(e,...t){let a=this.transaction(e,r?"readwrite":"readonly"),c=a.store;return o&&(c=c.index(t.shift())),(await Promise.all([c[n](...t),r&&a.done]))[0]};return v.set(t,a),a}m={...n=m,get:(e,t,o)=>E(e,t)||n.get(e,t,o),has:(e,t)=>!!E(e,t)||n.has(e,t)};let S=["continue","continuePrimaryKey","advance"],b={},B=new WeakMap,D=new WeakMap,x={get(e,t){if(!S.includes(t))return e[t];let n=b[t];return n||(n=b[t]=function(...e){B.set(this,D.get(this)[t](...e))}),n}};async function*k(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;let n=new Proxy(t,x);for(D.set(n,t),p.set(n,y(t));t;)yield n,t=await (B.get(n)||t.continue()),B.delete(n)}function M(e,t){return t===Symbol.asyncIterator&&u(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&u(e,[IDBIndex,IDBObjectStore])}m={...o=m,get:(e,t,n)=>M(e,t)?k:o.get(e,t,n),has:(e,t)=>M(e,t)||o.has(e,t)},console.log("[Init] transactions.js loaded");let C="localhost"===window.location.hostname?"http://localhost:5001/fintrack-1bced/us-central1/api":"https://us-central1-fintrack-1bced.cloudfunctions.net/api",L="transactions",P=1,T=[];async function _(){return console.log("[DB] Initializing IndexedDB v8"),function(e,t,{blocked:n,upgrade:o,blocking:r,terminated:a}={}){let c=indexedDB.open(e,8),s=f(c);return o&&c.addEventListener("upgradeneeded",e=>{o(f(c.result),e.oldVersion,e.newVersion,f(c.transaction),e)}),n&&c.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),s.then(e=>{a&&e.addEventListener("close",()=>a()),r&&e.addEventListener("versionchange",e=>r(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}("fintrack-cache",0,{upgrade(e){e.objectStoreNames.contains(L)&&e.deleteObjectStore(L),e.createObjectStore(L,{keyPath:"transaction_id"})}})}async function j(e,t){for(let n of(console.log("[Cache] Storing "+t.length+" transactions"),t)){let t=n.transaction_id||n.id;if(t){n.transaction_id=t;try{await e.put(L,n),console.log("[Cache] Stored tx",t)}catch(e){console.error("[Cache] Error storing tx",t,e)}}}}async function A(e){console.log("[Accounts] Building account map for user",e);let t=await (0,d.getDoc)((0,d.doc)(i.db,"users",e)),n=t.exists()&&t.data().plaid?.accounts||[];console.log("[Accounts] Found "+n.length+" accounts");let o={};for(let{accessToken:e}of n)try{let t=await fetch(`${C}/plaid/get_account_details`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e})});if(!t.ok){console.warn("[Accounts] accountsGet responded not ok");continue}(await t.json()).accounts.forEach(e=>{o[e.account_id]=e.name||"Cuenta",console.log("[Accounts] Map",e.account_id,"→",e.name)})}catch(e){console.error("[Accounts] fetch error",e)}return console.log("[Accounts] Completed account map"),o}async function O(e){console.log("[Fetch] Plaid transactions for",e);let t=await fetch(`${C}/plaid/get_transactions`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})});if(!t.ok)throw console.error("[Fetch] Failed to fetch Plaid transactions:",t.status),Error("Failed fetching Plaid transactions");let n=await t.json();return console.log("[Fetch] Retrieved "+n.transactions.length+" Plaid txs"),n.transactions.map(e=>({...e,transaction_id:e.transaction_id||e.id}))}function N(e){let t=document.createElement("div");return t.className="transaction-item",t.innerHTML=`
    <span class="account-label">${e.accountName}</span>
    <div class="desc">${e.description}</div>
    <span class="date">${new Date(e.date).toLocaleDateString()}</span>
    <span class="amount ${e.amount<0?"debit":"credit"}">
      ${e.amount<0?"-":"+"}${Math.abs(e.amount).toFixed(2)} \u{20AC}
    </span>
  `,t}function $(){let e=document.getElementById("month-filter").value;return e?T.filter(t=>t.date.startsWith(e)):T}function F(){console.log("[UI] showPage - page",P);let e=$();console.log("[UI] showPage - filtered tx count",e.length);let t=(P-1)*20,n=e.slice(t,t+20);document.getElementById("toggle-view").checked?function(e){let t=document.getElementById("transactions-list");t.innerHTML="",Object.entries(e.reduce((e,t)=>{let n=t.category||"Sin categoría";return(e[n]=e[n]||[]).push(t),e},{})).forEach(([e,n])=>{let o=document.createElement("div");o.className="category-group",o.innerHTML=`<h3>${e}</h3>`,n.forEach(e=>o.appendChild(N(e))),t.appendChild(o)})}(n):function(e){let t=document.getElementById("transactions-list");t.innerHTML="",e.forEach(e=>t.appendChild(N(e)))}(n);let o=Math.max(1,Math.ceil($().length/20));document.getElementById("prev-page").disabled=P<=1,document.getElementById("next-page").disabled=P>=o,document.getElementById("page-info").textContent=`P\xe1gina ${P} de ${o}`}async function U(e){console.log("[Main] loadTransactions for",e),await _();let t=await A(e);console.log("[Main] Got account map, keys:",Object.keys(t)),navigator.onLine&&(console.log("[Main] Syncing remote..."),fetch(`${C}/plaid/sync_transactions_and_store`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:e})}).catch(e=>console.error("[Sync] Error",e)));let n=[];try{n=await O(e)}catch(e){console.error("[Fetch] Plaid error",e)}!function(e,t){console.log("[Seed] Initializing subscription to history and summary months for",e);let n=(0,d.collection)(i.db,"users",e,"history"),o=(0,d.collection)(i.db,"users",e,"historySummary"),r=[],a=new Map,c=new Set;function s(){r.forEach(e=>e()),r=[],a.clear();let n=Array.from(c).sort();console.log("[Seed] Active months:",n),n.forEach(n=>{let o=(0,d.collection)(i.db,"users",e,"history",n,"items");console.log("[Seed] Subscribing to items of month",n);let c=(0,d.onSnapshot)(o,e=>{console.log("[Seed] Item changes for month",n,e.docChanges().length,"changes"),e.docChanges().forEach(e=>{let t=e.doc,n=t.data().transaction_id||t.id;console.log("[Seed] change type",e.type,"for tx",n),"removed"===e.type?a.delete(n):a.set(n,{...t.data(),transaction_id:n})});let o=Array.from(a.values());console.log("[Seed] Delivering",o.length,"seed transactions"),t(o)},e=>console.error("[Seed] items snapshot error",e));r.push(c)})}(0,d.onSnapshot)(n,e=>{e.docs.forEach(e=>c.add(e.id)),console.log("[Seed] history months snapshot:",e.docs.map(e=>e.id)),s()},e=>console.error("[Seed] history snapshot error",e)),(0,d.onSnapshot)(o,e=>{e.docs.forEach(e=>c.add(e.id)),console.log("[Seed] summary months snapshot:",e.docs.map(e=>e.id)),s()},e=>console.error("[Seed] summary snapshot error",e))}(e,async e=>{if(console.log("[Main] Received seedTxs count",e.length),console.log("[Main] combined tx count",(T=Array.from(new Map([...n,...e].map(e=>[e.transaction_id,e])).values()).sort((e,t)=>new Date(t.date)-new Date(e.date)).map(e=>({...e,accountName:t[e.account_id]||"Desconocida"}))).length),!window.hasInitializedUI){console.log("[UI] Setting up event listeners");let e=document.getElementById("month-filter"),t=document.querySelector(".month-icon");t&&(t.onclick=()=>e.showPicker?e.showPicker():e.focus()),e.onchange=()=>{P=1,F()},document.getElementById("prev-page").onclick=()=>{console.log("[UI] Prev page click"),P>1&&(P--,F())},document.getElementById("next-page").onclick=()=>{console.log("[UI] Next page click");let e=Math.ceil($().length/20);P<e&&(P++,F())},document.getElementById("toggle-view").onchange=()=>{P=1,F()},window.hasInitializedUI=!0,console.log("[Main] UI initialized")}F();let o=await _();await j(o,T)})}(0,l.onAuthStateChanged)(i.auth,e=>{if(console.log("[Auth] onAuthStateChanged",e?.uid),!e)return window.location.href="../index.html";U(e.uid)}),window.addEventListener("online",()=>{console.log("[Network] online event"),i.auth.currentUser&&U(i.auth.currentUser.uid)});
//# sourceMappingURL=transactions.a48ff726.js.map
